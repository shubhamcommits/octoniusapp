<mat-dialog-actions align="end">
  <div class="action-box">
      <a (click)="onCloseDialog()" mat-dialog-close>
        <i class="material-icons" style="cursor: pointer">close</i>
      </a>
  </div>
</mat-dialog-actions>

<div class="post-dialog-content" *ngIf="objectExists(postData) && postData._id">
    <div class="post-content">
        <div>
          <div class="content-box">
            <div class="modal-header">
              <!-- Event Post Header starts -->
              <h4 class="modal-title">
                <!-- Post Title starts -->
                <input name="postTitle" type="text" [ngModel]="title" (blur)="titleChange($event)" class="post-title"
                  placeholder="âœðŸ» Title" />
                <!-- Post Title ends -->
              </h4>
        
              <i class="material-icons-outlined ml-2" *ngIf="isIdeaModuleAvailable && postData?.task?.is_idea"
                style="color: #FBB732;">emoji_objects</i>
        
              <app-post-utils *ngIf="userData" [post]="postData" [userData]="userData" [groupData]="groupData"
                [canEdit]="canEdit" mode="fullscreen" (delete)="deletePost()">
              </app-post-utils>
            </div>
            <!-- Post Header Title ends -->
        
            <!-- Post Content starts -->
            <app-quill-editor *ngIf="canEdit" [editorId]="'postbox-editor'" [toolbar]="canEdit" [readOnly]="!canEdit"
              [quillContent]="postData?.content" [groupId]="groupId" (contentEmitter)="quillContentChanged($event)">
            </app-quill-editor>
            <!-- Post Content ends -->
        
            <!-- Attach files starts -->
            <div class="attach-files">
              <app-attach-files [post]="postData" (files)="onAttach($event)" (cloudFiles)="onCloudFileAttach($event)">
              </app-attach-files>
            </div>
            <!-- Attach files ends -->

            <app-post-actions [post]="postData" [userData]="userData" [fullscreen]="true" [groupData]="groupData"
              [isIdeaModuleAvailable]="isIdeaModuleAvailable" [canEdit]="canEdit" (pinEvent)="onPostPin($event)"
              (newCommentEmitter)="newCommentAdded($event)">
            </app-post-actions>
          </div>
        </div>

        <div class="clearfix save-content">
            <button *ngIf="canEdit" [disabled]="!contentChanged"
              class="btn float-right btn-primary btn-md"
              (click)="updateDetails('change_content')" i18n="@@taskDialog.save">
                Save
            </button>

            <button *ngIf="!showSubtasks && !postData?.task?._parent_task && postData?.type === 'task' && (!postData?.task?.shuttle_type || groupData?._id == postData?._group?._id) && canEdit"
              class="btn float-left btn-warning btn-md"
              (click)="prepareToAddSubtasks()"
              i18n="@@taskDialog.addSubtask">
                + Add Subtasks
            </button>
        </div>

        <div class="content-box" *ngIf="(showSubtasks && (!postData?.task?.shuttle_type || groupData?._id == postData?._group?._id))
            || (postData?.comments_count > 0) || (postData?.logs && postData?.logs?.length > 0)
            || (postData?.type === 'task' && postData?.approval_active && postData?.approval_history && postData?.approval_history?.length > 0)
            || (postData?.type === 'task')">
          <!-- TABS STARTS -->
          <mat-tab-group mat-align-tabs="start" [selectedIndex]="selectedTab" animationDuration="0ms">
            <!-- subtasks STARTS-->
            <mat-tab *ngIf="showSubtasks && (!postData?.task?.shuttle_type || groupData?._id == postData?._group?._id)">
              <ng-template mat-tab-label>
                <span i18n="@@taskDialog.subtasks">Subtasks</span>
              </ng-template>

              <ng-template matTabContent>
                <app-subtasks
                  [subtasks]="subtasks"
                  [groupData]="groupData"
                  [userData]="userData"
                  [parentId]="postData?._id"
                  [parentNS]="false"
                  (openSubtaskEmitter)="onOpenSubtask($event)"></app-subtasks>
              </ng-template>
            </mat-tab>
            <!-- subtasks ENDS-->

            <!-- comment-list STARTS-->
            <mat-tab *ngIf="postData?.comments_count > 0">
              <ng-template mat-tab-label>
                <span i18n="@@taskDialog.comments">Comments</span>
              </ng-template>

              <ng-template matTabContent>
                <app-comment-list
                  [postId]="postData?._id"
                  [userData]="userData"
                  [groupId]="postData?._group?._id || postData?._group"
                  [length]="postData?.comments_count"
                  [newComment]="newComment"></app-comment-list>
              </ng-template>
            </mat-tab>
            <!-- comment-list ENDS-->

            <!-- time-tracking STARTS-->
            <mat-tab *ngIf="postData?.type == 'task'">
              <ng-template mat-tab-label>
                <span i18n="@@taskDialog.timeTracking">Time tracking</span>
              </ng-template>

              <ng-template matTabContent>
                <app-task-time-tracking
                  [userId]="userData?._id"
                  [groupId]="groupData?._id"
                  [postData]="postData">
                </app-task-time-tracking>
              </ng-template>
            </mat-tab>
            <!-- time-tracking ENDS-->

            <!-- APPROVALS HISTORY STARTS-->
            <mat-tab *ngIf="postData?.type === 'task' && postData?.approval_active && postData?.approval_history && postData?.approval_history?.length > 0&& isBusinessSubscription">
              <ng-template mat-tab-label>
                <span i18n="@@taskDialog.approvalsHistory">Approvals History</span>
              </ng-template>

              <ng-template matTabContent>
                <app-approvals-history
                  [groupId]="groupData?._id"
                  [userData]="userData"
                  [itemData]="postData"
                  [type]="'post'"></app-approvals-history>
              </ng-template>
            </mat-tab>
            <!-- APPROVALS HISTORY ENDS-->

            <!-- TASK CHANGES HISTORY STARTS-->
            <mat-tab *ngIf="postData?.logs && postData?.logs?.length > 0">
              <ng-template mat-tab-label>
                <span i18n="@@taskDialog.changeLog">Change Log</span>
              </ng-template>

              <ng-template matTabContent>
                <app-post-logs [logs]="postData?.logs"></app-post-logs>
              </ng-template>
            </mat-tab>
            <!-- TASK CHANGES HISTORY ENDS-->
          </mat-tab-group>
          <!-- TABS ENDS -->
        </div>
    </div>

    <!-- Top Right Section starts -->
    <div  *ngIf="!!groupData && (!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task
            && (groupData?.dialog_properties_to_show?.task?.includes('status') || groupData?.dialog_properties_to_show?.task?.includes('date')
              || groupData?.dialog_properties_to_show?.task?.includes('crm_setup') || groupData?.dialog_properties_to_show?.task?.includes('assignee')
              || groupData?.dialog_properties_to_show?.task?.includes('tags') || groupData?.dialog_properties_to_show?.task?.includes('custom_fields')
              || groupData?.dialog_properties_to_show?.task?.includes('actions') || groupData?.dialog_properties_to_show?.task?.includes('approvals')
              || groupData?.dialog_properties_to_show?.task?.includes('shuttle_task') || groupData?.dialog_properties_to_show?.task?.includes('parent_task')))"
      class="post-properties">

        <!-- Parent Task starts -->
        <div class="content-box" *ngIf="(postData?.task?._parent_task && (postData?._group && groupData?._id == postData?._group?._id)
              && (!postData?.task?._parent_task?.task?.isNorthStar || postData?.task?._parent_task?._group))
          && (!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && !!groupData?.dialog_properties_to_show?.task && groupData?.dialog_properties_to_show?.task?.includes('parent_task'))">
          <p class="box-title" i18n="@@taskDialog.parentTask"> Parent task</p>

          <div class="parent-task">
            <div style="display: flex; flex-direction: row; justify-content: space-between; width: 100%;" (click)="openParentTask(postData?.task?._parent_task._id)">
              <div class="parent-title">
                {{ postData?.task?._parent_task.title | truncatetext:40 }}
              </div>

              <app-assignee-avatar [post]="postData?.task?._parent_task" [userData]="userData" style="margin-right: 10px;"></app-assignee-avatar>
            </div>
          </div>
        </div>
        <!-- Parent Task ends -->

        <!-- Status starts -->
        <div class="content-box" *ngIf="(!!groupData.dialog_properties_to_show && groupData?.dialog_properties_to_show?.task?.includes('status'))">
          <p class="box-title"i18n="@@taskDialog.taskStatus"> Task Status</p>

          <div class="shuttle-box mb-2">
            <p class=" mt-1" style="width:70px" i18n="@@taskDialog.status">Status</p>

            <!-- Change task status starts -->
            <app-task-status class="ml-2"
                *ngIf="myWorkplace || groupData?._id == postData?._group?._id"
                [postId]="postData?._id"
                [groupId]="postData?._group?._id || postData?._group"
                [userId]="userData?._id"
                [status]="postData?.task?.status"
                [disabled]="postData?.archived || !canEdit"
                [shuttleType]="false"
                (status)="changeTaskStatus($event)">
            </app-task-status>

            <app-task-status class="ml-2"
                *ngIf="!myWorkplace && groupData?._id != postData?._group?._id"
                [postId]="postData?._id"
                [groupId]="shuttle?._shuttle_group?._id || shuttle?._shuttle_group"
                [userId]="userData?._id"
                [status]="shuttle?.shuttle_status"
                [disabled]="postData?.archived || !canEdit"
                [shuttleType]="true"
                (status)="changeShuttleTaskStatus($event)">
            </app-task-status>
            <!-- Change task status ends -->
          </div>

          <div class="shuttle-box" *ngIf="columns">
            <p class="mt-1" *ngIf="(((shuttle?._shuttle_group?._id || shuttle?._shuttle_group) != groupId) && (!postData?.task?._parent_task || !this.postData?.task?._parent_task?._group)) || ((shuttle?._shuttle_group?._id || shuttle?._shuttle_group) == groupId)"
                style="margin-top: 18px; width:70px" i18n="@@taskDialog.section">
              Section
            </p>

            <!-- Change task column starts -->
            <app-change-column class="ml-2"
                *ngIf="!postData?.task?.shuttle_type || (groupData?._id == postData?._group?._id && !postData?.task?._parent_task)"
                [sectionId]="(postData?.task?._column?._id || postData?.task?._column)"
                [columns]="columns"
                [disabled]="postData?.archived || !canEdit"
                (moveTask)="moveTaskToColumn($event)">
            </app-change-column>

            <app-change-column class="ml-2"
                *ngIf="(postData?.task?.shuttle_type && groupData?._id != postData?._group?._id)"
                [sectionId]="(shuttle?._shuttle_section?._id || shuttle?._shuttle_section)"
                [columns]="columns"
                [disabled]="postData?.archived || !canEdit"
                (moveTask)="moveShuttleTaskToSection($event)">
            </app-change-column>
            <!-- Change task column ends -->
          </div>
        </div>
        <!-- Status ends -->

        <!-- Shuttle Task starts -->
        <app-shuttle-task *ngIf="isShuttleTasksModuleAvailable && groupData?.shuttle_type && postData?.task?.shuttle_type && (!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && groupData?.dialog_properties_to_show?.task?.includes('shuttle_task'))"
          [postData]="postData"
          [groupData]="groupData"
          [userData]="userData"
          [isShuttleTasksModuleAvailable]="isShuttleTasksModuleAvailable"></app-shuttle-task>
        <!-- Shuttle Task ends -->

        <!-- Dates starts -->
        <app-post-dates *ngIf="!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && groupData?.dialog_properties_to_show?.task?.includes('date')"
          [userData]="userData"
          [postData]="postData"
          [groupData]="groupData"
          [canEdit]="canEdit"
          (startDateEvent)="getStartDate($event)"
          (dueDateEvent)="getDueDate($event)"></app-post-dates>
        <!-- Dates ends -->

        <!-- Assignee Modal starts -->
        <div class="content-box" *ngIf="!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && groupData?.dialog_properties_to_show?.task?.includes('assignee')">
          <p class="box-title" i18n="@@taskDialog.assignee">Assignee</p>
          
          <app-multiple-assignments
            [canEdit]="canEdit"
            [groupId]="groupId"
            [post]="postData"
            [type]="'post'"
            (assigneeAddedEmiter)="onAssigned($event)"
            (assigneeRemovedEmiter)="onAssigned($event)">
          </app-multiple-assignments>
          
          <div *ngIf="lastAssignedBy" id="avatar-assignee">
            <p class="box-title" style="padding-top: 20px;" i18n="@@taskDialog.assignedBy">Assigned by</p>
            
            <app-secured-image
              [imgURL]="lastAssignedBy.profile_pic"
              [service]="'user'"
              [userData]="lastAssignedBy"
              [workspaceId]="(userData?._workspace?._id || userData?._workspace)"
              [styleClass]="'feed-avatar-small'"
              style="float: left; cursor: auto;"></app-secured-image>
            
            <div style="padding-top: 10px;" class="ml-1">
              {{ lastAssignedBy?.first_name }}
              {{ lastAssignedBy?.last_name }}
            </div>
          </div>
          
          <div id="avatar-assignee" style="margin-bottom: 30px;">
            <p class="box-title" style="padding-top: 20px;" i18n="@@taskDialog.createdBy">Created by</p>
            
            <app-secured-image *ngIf="postData?._posted_by"
              [imgURL]="postData?._posted_by?.profile_pic"
              [service]="'user'"
              [userData]="postData?._posted_by"
              [workspaceId]="(userData?._workspace?._id || userData?._workspace)"
              [styleClass]="'feed-avatar-small'"
              style="float: left; cursor: auto;"></app-secured-image>
            
            <div style="padding-top: 10px;" class="ml-1">
              {{ postData?._posted_by?.first_name }}
              {{ postData?._posted_by?.last_name }}
              <span class="muted" i18n="@@taskDialog.on">on {{ postData?.created_date | date: 'MMM dd, yyyy'}}</span>
            </div>
          </div>
          
        </div>
        <!-- Assignee Modal ends -->

        <!-- CRM Lead Card starts -->
        <div class="content-box" *ngIf="!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && groupData?.dialog_properties_to_show?.task?.includes('crm_setup')">
          <app-crm-lead-card [postData]="postData" [userData]="userData" [groupData]="groupData"
            [isAdmin]="canEdit"></app-crm-lead-card>
        </div>
        <!-- CRM Lead Card ends -->

        <!-- Post Tags starts -->
        <div class="content-box" *ngIf="!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && groupData?.dialog_properties_to_show?.task?.includes('tags')">
            <p class="box-title" i18n="@@taskDialog.tags">Tags</p>

            <app-tags
                [canEdit]="canEdit"
                [item]="postData"
                [userData]="userData"
                [groupId]="groupId"
                (tags)="getTags($event)">
            </app-tags>
        </div>
        <!-- Post Tags ends -->

        <div class="content-box" *ngIf="postData?.type === 'task' && postData?._group && customFields?.length > 0 && (!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && groupData?.dialog_properties_to_show?.task?.includes('custom_fields'))">
            <p class="box-title" i18n="@@taskDialog.customFields">Custom fields</p>

            <div *ngFor="let cf of customFields; trackBy: utilityService.trackByIndex" class="d-flex custom-field justify-content-start mb-3 row">
                <p class="col">{{ cf.title }}</p>
                <mat-select ngDefaultControl *ngIf="!cf.input_type"
                    [(value)]="selectedCFValues[cf.name]"
                    [disabled]="!canEdit"
                    (openedChange)="cfSearchText = ''"
                    (selectionChange)="onCustomFieldChange($event, cf.name, cf.title)"
                    appearance="fill"
                    class="col">
                    <mat-select-trigger>{{ selectedCFValues[cf.name] }}</mat-select-trigger>
                    <input type="text" class="form-control" [id]="'search-text' + cf.name" [(ngModel)]="cfSearchText"
                      [placeholder]="cfSearchPlaceholder" autofocus
                      (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
                    <mat-option *ngFor="let val of cf.values | appFilter: cfSearchText; trackBy: utilityService.trackByIndex" [value]="val">{{ val }}</mat-option>
                </mat-select>

                <div *ngIf="cf.input_type && !cf.input_type_date" class="col" style="display: flex; float: left; width: 125px;">
                  <input [type]="(cf.input_type_number) ? 'number': 'text'" [name]="cf.name" [(ngModel)]="selectedCFValues[cf.name]"
                      [disabled]="!canEdit"
                      class="col" style="width: 94px;" [value]="selectedCFValues[cf.name]"
                      (keyup.enter)="saveInputCustomField($event, cf.name, cf.title)" />
                  <i *ngIf="canEdit" (click)="saveCustomField(cf.name, cf.title, selectedCFValues[cf.name]);" class="material-icons muted mr-5"
                    style="cursor: pointer; font-size: 14px; margin-left: 10px;color: #0bc6a0;">save</i>
                </div>

                <div *ngIf="cf.input_type && cf.input_type_date" >
                  <!-- Date Picker starts -->
                  <app-date-picker (date)="getCFDate($event, cf.name, cf.title)"
                    [selectedDate]="selectedCFValues[cf.name]"
                    [styleClass]="'btn-group input-date'"
                    [canEdit]="canEdit">
                  </app-date-picker>
                  <!--Date Picker ends -->
                </div>

                <!-- Clean field starts -->
                <i *ngIf="canEdit" (click)="saveCustomField(cf.name, cf.title, null);"
                  class="material-icons muted mr-5"
                  style="cursor: pointer; font-size: 14px; margin-left: 10px;">remove_circle_outline</i>
                <!-- Clean field ends -->
            </div>
        </div>

        <app-task-actions *ngIf="userData && canEdit && (!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && groupData?.dialog_properties_to_show?.task?.includes('actions'))"
          [postData]="postData"
          [groupData]="groupData"
          [userData]="userData"
          [tasks]="tasks"
          [isNorthStar]="false"
          [isIdea]="(postData?.task?.is_idea) ? postData?.task?.is_idea : false"
          [isIdeaModuleAvailable]="isIdeaModuleAvailable"
          [isCRMLead]="(postData?.task?.is_crm_task) ? postData?.task?.is_crm_task : false"
          [isCRMOrder]="(postData?.task?.is_crm_order) ? postData?.task?.is_crm_order : false"
          [isShuttleTasksModuleAvailable]="isShuttleTasksModuleAvailable"
          [isMilestone]="(postData?.task?.is_milestone) ? postData?.task?.is_milestone : false"
          [canEdit]="canEdit"
          (parentTaskSelectedEmitter)="onParentTaskSelected($event)"
          (dependencyTaskSelectedEmitter)="onDependencyTaskSelected($event)"
          (taskClonedEmitter)="onTaskClonned($event)"
          (taskFromTemplateEmitter)="openParentTask($event)"
          (taskEstimationEmitter)="onEstimationChanged($event)"
          (transformIntoNorthStarEmitter)="transformToNorthStart($event)"
          (transformIntoMilestoneEmitter)="transformToMileStone($event)"
          (transformIntoIdeaEmitter)="transformToIdea($event)"
          (shuttleGroupEmitter)="setShuttleGroup($event)">
        </app-task-actions>

        <!-- APPROVAL STARTS -->
        <div class="content-box" *ngIf="isBusinessSubscription && (!!groupData.dialog_properties_to_show && !!groupData.dialog_properties_to_show.task && groupData?.dialog_properties_to_show?.task?.includes('approvals'))">
          <app-approval-actions
            [groupId]="groupData?._id"
            [userData]="userData"
            [itemData]="postData"
            [type]="'post'"
            [canEdit]="canEdit"
            (assigneeEmiter)="onAssigneeEmitter($event)"
            (approvalFlowLaunchedEmiter)="onApprovalFlowLaunchedEmiter($event)"></app-approval-actions>
        </div>
        <!-- APPROVAL ENDS -->
    </div>
    <!-- Top Right Section ends -->
</div>

<!-- Loading Spinner Starts -->
<ng-container *ngIf="isLoading$ | async">
  <app-loading-spinner class="media"></app-loading-spinner>
</ng-container>
<!-- Loading Spinner Ends -->
