<div class="budget-dialog-content">
  <mat-dialog-actions align="end">
      <div class="action-box">
          <a (click)="cancel()" mat-dialog-close>
          <i  class="material-icons" style="cursor: pointer">close</i>
          </a>
      </div>
  </mat-dialog-actions>

  <div class="budget-properties budget-box new-record-form">
    <div>
      <h3 class="">
        <!-- <span class="material-icons" style="line-height: 35px;">monetization_on</span> -->
        <span i18n="@@projectBudgetDialog.budgetManagement">Budget Management</span>
        <i class="material-icons-outlined muted" (click)="showEditBudget = !showEditBudget" style="cursor: pointer; float: right;">edit</i>
      </h3>

      <hr />

      <div class="budget-details">
        <div class="container">
          <div class="row">
            <div class="col">
              <label class="bold" i18n="@@projectBudgetDialog.totalBudget">Total Budget</label>
              <span class="badget-badge">{{ budget.amount_planned | currency: budget.currency }}</span>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label class="bold" i18n="@@projectBudgetDialog.currentBalance">Current Balance</label>
              <span class="badget-badge" [ngClass]="getBudgetStyle()">{{ budget.amount_planned - totalSpent | currency: budget.currency }}</span>
            </div>
          </div>
          
          <div *ngIf="showEditBudget" class="row flexform form-group" style="margin-top: 20px;">
            <div class="planned_budget mr-2">
              <i class="material-icons-outlined muted">attach_money</i>
            
              <input class="" name="target" type="number" [(ngModel)]="budget.amount_planned" [placeholder]="budgetPlaceholder"
                (keyup.enter)="saveBudget()" (focusout)="saveBudget()">
            </div>

            <div class="col" style="padding-left: 0;">
              <mat-form-field class="currency_select">
                <mat-select ngDefaultControl (selectionChange)="saveBudget()" (click)="$event.stopPropagation()"
                  [(ngModel)]="budget.currency" name="new_type">
                  <mat-option *ngFor="let currency of currencies" [value]="currency.code">{{ currency.name }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <div class="row" *ngIf="showEditBudget">
            <button class="btn btn-outline-danger btn-md float-left" (click)="showEditBudget = !showEditBudget">
              <span i18n="@@taskTimeTracking.close">X Close</span>
            </button>
          </div>
        </div>
      </div>

      <div class="budget_graph">

        <div class="d-md-none d-lg-block" *ngIf="chartReady">
          <canvas
            baseChart
            height="100"
            [data]="doughnutChartData"
            [labels]="doughnutChartLabels"
            [chartType]="doughnutChartType"
            [options]="doughnutChartOptions"
            [colors]="doughnutChartColors"
            [plugins]="doughnutChartPlugins"></canvas>
        </div>
      </div>

      <hr style="clear: both; border: none;" />
    </div>
  </div>

  <div class="budget-content budget-box new-record-form">
    <div *ngIf="showAddExpenseForm">
      <div class="flexform form-group">
        <div class="time_spent mr-2">
          <i class="material-icons-outlined muted">attach_money</i>

          <input type="number" [(ngModel)]="expense.amount" style="border: none;" />
        </div>

        <div class="calendar mr-2">
          <app-date-picker class="" name="entryDate" [styleClass]="'input-date calendar'" (date)="getDate($event)"
            [selectedDate]="expense.date">
          </app-date-picker>
        </div>
    
        <div class="user">
          <app-multiple-assignments [workspaceData]="workspaceData" [assigned_to]="entryUserArray" [type]="'time-tracking'"
            [groupId]="groupData?._id" (assigneeAddedEmiter)="onAssignedAdded($event)"
            (assigneeRemovedEmiter)="onAssignedRemoved($event)">
          </app-multiple-assignments>
        </div>
      </div>
    
      <div class="row">
        <div class="col-md-12 form-control" style="width: 400px;">
          <textarea rows="4" [(ngModel)]="expense.reason" [placeholder]="reasonPlaceholder" style="border: none;"></textarea>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-outline-primary btn-md float-left" (click)="saveExpense()" [disabled]="!isValidEntry()">
        <i class="material-icons-outlined">attach_money</i>
        <span i18n="@@taskTimeTracking.addEntry" *ngIf="!expense._id">Add expense</span>
        <span i18n="@@taskTimeTracking.addEntry" *ngIf="!!expense._id">Save expense</span>
      </button>
    
      <button class="btn btn-outline-danger btn-md float-left" style="margin-left: 30px;" (click)="resetExpense()"
        *ngIf="showAddExpenseForm">
        <span i18n="@@taskTimeTracking.cancel">X Cancel</span>
      </button>
    </div>

    <hr style="clear: both; border: none;" />

    <div style="margin-top: 30px;" *ngIf="budget?.expenses && budget?.expenses.length > 0">
      <div class="expense content-box" *ngFor="let expense of budget?.expenses; let index = index">
        <div *ngIf="!expense.isTT">
          <app-secured-image
            [imgURL]="expense?._user?.profile_pic"
            [service]="'user'"
            [workspaceId]="(currentUser?._workspace?._id || currentUser?._workspace)"
            [styleClass]="'avatar'"
            style="margin-right:15px"></app-secured-image>
          &nbsp;
          {{ expense?._user?.first_name || 'Deleted' }} {{ expense?._user?.last_name || 'User' }}
          &nbsp;
          <span>
            &nbsp;<span i18n="@@projectBudgetDialog.added">added</span>&nbsp;
            <span class="bold">
              {{ expense.amount | currency: budget.currency }}
            </span>
            &nbsp;-&nbsp;
            <span style="font-weight: 900;">
              {{ expense.reason }}
            </span>
          </span>
        </div>

        <div *ngIf="!!expense.isTT">
          <app-secured-image
            [imgURL]="expense?._user?.profile_pic"
            [service]="'user'"
            [workspaceId]="(currentUser?._workspace?._id || currentUser?._workspace)"
            [styleClass]="'avatar'"
            style="margin-right:15px"></app-secured-image>
          &nbsp;
          {{ expense?._user?.first_name || 'Deleted' }} {{ expense?._user?.last_name || 'User' }}
          &nbsp;
          <span>
            &nbsp;<span i18n="@@projectBudgetDialog.registered">registered</span>&nbsp;
            <span class="bold">{{ expense?.hours + 'h and ' + expense?.minutes+ 'm' }}</span>
            &nbsp;<span i18n="@@projectBudgetDialog.toTheTask">to the task</span>&nbsp;
            <span class="bold">{{ expense?._task?.title }}</span>
            &nbsp;<span i18n="@@projectBudgetDialog.onTheCategory" *ngIf="!!expense?._task?._category">to the category</span>&nbsp;
            <span class="bold">{{ expense?._task?._category }}</span>
            &nbsp;<span i18n="@@projectBudgetDialog.whichCost">which cost</span>&nbsp;
            <span class="bold">
              {{ expense.amount | currency: budget.currency }}
            </span>
            &nbsp;
            <span *ngIf="!!expense.reason">-&nbsp;</span>
            <span class="bold" style="font-weight: 900;">
              {{ expense.reason }}
            </span>
          </span>
        </div>

        <div>
          <span>
            {{ formateDate(expense.date, 'MMM Do, YYYY') }}
          </span>

          <span *ngIf="!expense.isTT && (expense?._user?._id == currentUser?._id || expense?._created_user?._id == currentUser?._id)">
            <i class="material-icons-outlined ml-2 muted" [matMenuTriggerFor]="menu" style="cursor: pointer;">more_horiz</i>
            <mat-menu #menu="matMenu">
              <a mat-menu-item (click)="editExpense(expense)">
                <i class="material-icons-outlined ml-2" style="margin-right: .7rem;">edit</i>
                <span i18n="@@projectBudgetDialog.edit">Edit</span>
              </a>
              <a mat-menu-item (click)="removeExpense(expense)">
                <i class="material-icons-outlined ml-2" style="margin-right: .7rem;">delete</i>
                <span i18n="@@projectBudgetDialog.delete">Delete</span>
            </a>
            </mat-menu>
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
