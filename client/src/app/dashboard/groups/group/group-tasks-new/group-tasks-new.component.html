

<div class="row" style="margin-bottom: 1%;">
  <div class="col-md-4">
    <button class="btn btn-primary stickybtn" id="task" (click)="openNewTaskModal(newTaskModal)">  <i class="material-icons">check</i> New Task</button> &nbsp;
    <button class="btn btn-primary stickybtn" id="task" (click)="openNewColumnModal(newColumnModal)">  <i class="material-icons">add</i> New Column</button>
  </div>
</div>

<div class = "row main-box" cdkDropList [cdkDropListData]="taskList" (cdkDropListDropped)="onTrackDrop($event)" cdkDropListOrientation="horizontal">
  <div *ngFor="let column of taskList; let i = index;" class = "col-md-4" [style.backgroundColor] = "changeBg[i]">
    <div class = "card-main">
      <div class="kanbanheader" [style.backgroundColor] = "bgColor[i%bgColor.length]" cdkDragHandle >
        {{ column.title }}
        <div *ngIf="column.title != 'to do' && column.title != 'in progress' && column.title != 'done'">
          <button class = "cross" (click)="openEditColumnModal(editColumnModal, column.title)"><i class="material-icons">create</i></button>
        </div>
      </div>

      <div *ngIf="isLoading$ | async">
        <div class="load-8">
          <h6><b>Loading Data...</b></h6>
          <div class="line"></div>
        </div>
      </div>
      
      <div [ngClass]="{'card-main-body': true, 'dragging-cover': changeBg[i]}"> 
        <div *ngIf="!(isLoading$ | async)">
          <div *ngIf="column.tasks.length > 0;" cdkDropList [cdkDropListData]="column.tasks"
              (cdkDropListDropped)="onTaskDrop($event)" [id]="column.id" [cdkDropListConnectedTo]="taskIds">
            <div *ngFor="let post of column.tasks" cdkDrag [cdkDragDisabled]="post.title == 'proxy'" (cdkDragStarted)="entered($event)" (CdkDragEnd)="exited($event)">
              <div *ngIf="post.title == 'proxy' ">
                  <img src='../../../assets/images/empty-todo.svg' style="max-width:80%;"> 
              </div>
              <div *ngIf="post.title != 'proxy' " class="card">  
                <div class="card-block ">
                  <div class="card-title">
      
      
                    <div ngbDropdown #myDrop="ngbDropdown">
      
                      <img (click)="$event.stopPropagation(); myDrop.toggle();"
                        src="{{this.BASE_URL}}/uploads/{{this.post.task?._assigned_to?.profile_pic}}" id="dropdownToDo"
                        ngbDropdownAnchor (focus)="myDrop.open()" onerror="this.src='/assets/images/user.png'"
                        class="topnav-avatar float-left kbn">
                      <h6 class="kbn">{{post.task?._assigned_to?.first_name}}
                        {{post.task?._assigned_to?.last_name}} <br><span class="small lightgray date">
                          {{post?.created_date | date : 'medium'}}</span>
                      </h6>
                      <p class="small font-weight-bold" style="margin-top: 5px" *ngIf="post.task?.due_to != 'Invalid date'">
                        due {{post.task?.due_to | date}}<br /><span class="small kbn-working-color font-weight-bold"
                          style="margin-left: 4rem;" *ngIf="post.task?.started_at && post.task?.completed_at"> time spent:
                          {{ getTaskTimeSpent(post) }} days</span></p>
      
      
                      <div ngbDropdownMenu aria-labelledby="dropdownTodo">
                        <div *ngFor="let admin of group_admins">
                          <button class="dropdown-item" (click)="changeTaskAssignee(post._id, admin._id, post)">
                            {{admin?.first_name}}
                            {{admin?.last_name}}
                          </button>
                        </div>
                        <div *ngFor="let member of group_members">
                          <button class="dropdown-item" (click)="changeTaskAssignee(post._id, member._id, post)">
                            {{member?.first_name}}
                            {{member?.last_name}}
                          </button>
                        </div>
      
                      </div>
      
                    </div>
      
                  </div>
                  <div class="card-body">
      
                    <span class="assigned"> Assigned by {{this.post._posted_by?.first_name}}
                      {{this.post._posted_by?.last_name}}<br /> in {{this.post._group?.group_name}} group
                    </span>
      
                    <div ngbDropdown class="d-inline-block float-right status">
                      <button class="btn btn-sm" id="dropdownDone" [style.backgroundColor] = "bgColor[i%bgColor.length]" style = "color:#fff;" ngbDropdownToggle>{{post.task.status}}</button>
                      <div ngbDropdownMenu aria-labelledby="dropdownToDo">
                        <div *ngFor="let col of allColumns">
                          <button class="dropdown-item" (click)="updateTaskColumn(this.post._id, this.post.task.status, col.title)"> {{ col.title }}</button>  
                        </div>
                      </div>
                    </div>
      
                    <ng-template #taskif>
                      <div class="col-md-4 text-right padding-topright">
                        <button class="btn btn-pink btn-sm" id="button_task_mark_completed" (click)="OnMarkTaskCompleted()">
                          Mark
                          complete
                        </button>
                        <p class="small font-weight-bold" style="margin-top: 5px" *ngIf="post.task?.due_to != 'Invalid date'">
                          due {{post.task?.due_to
                          | date}}</p> <br /><span class="small kbn-working-color font-weight-bold"
                          *ngIf="post.task?.started_at && post.task?.completed_at"> time spent:
                          {{ getTaskTimeSpent() }} days</span>
                      </div>
                    </ng-template>
                    <hr>
                    <a style="text-decoration:none; color:inherit;"
                      [routerLink]="['/dashboard/group/', post._group?._id, 'post',post._id]">
                      <!-- COMPLETED POST TITLE -->
                      <div class="col-md-12 innercard font-weight-bold" style="font-size: 18px;"
                        [innerHTML]="post?.title | safe: 'html'">
                      </div>
                    </a>
                  </div>
      
                </div>  
              </div>
            </div>
          </div>
        </div>
      </div>
        <ng-template #noToDoTasks>
          <img src='../../../assets/images/empty-todo.svg' style="max-width:80%;">
        </ng-template>
    </div>

  </div> 
</div>

<!-- ########## MODALS ########## -->

<!-- CREATE A NEW TASK MODAL -->

<ng-template #newColumnModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Create a new Column </h4>
  </div>
  <div class="modal-body">
    <input id="post-title" type="text" name="postTitle" [(ngModel)]="columnName" placeholder="Insert Column Name here ..." style="padding: 12px 15px; font-style: italic; width: 100%; outline: none;" />
    <div class="row" style="margin-top:15px;">
      <div class="col-md-12 text-right">
        <button (click)="closeNewColumnModal()" class="btn btn-default" id="cancel-task">Cancel</button>
        <button [disabled]="readyToAddColumn()" class="btn btn-primary" id="create-task"
                (click)="addNewColumn();">Add Column
        </button>
      </div>
    </div>
  </div>

</ng-template>

<ng-template #editColumnModal let-modal>
    <div class="modal-header">
      <h4 class="modal-title" id="modal-basic-title">Edit Column</h4>
    </div>
    <div class="modal-body">
      <input id="post-title" type="text" name="postTitle" [(ngModel)]="editColumnNameNew" style="padding: 12px 15px; font-style: italic; width: 100%; outline: none;" />
      <div class="row" style="margin-top:15px;">
        <div class="col-md-12 text-right">
          <button (click)="closeEditColumnModal()" class="btn btn-default" id="cancel-task">Cancel</button>
          <button [disabled]="readyToEditColumnName()" class="btn btn-primary" id="create-task"
                  (click)="editColumnName();">Edit Column Name
          </button>
          <button [disabled]="readyToDeleteColumn()" class="btn btn-danger" id="create-task"
                  (click)="deleteColumn(editColumnNameOld);">Delete Column
          </button>
        </div>
      </div>
    </div>
  
</ng-template>

<ng-template #newTaskModal let-modal>
    <div class="modal-header">
      <h4 class="modal-title" id="modal-basic-title">Create a new task</h4>
    </div>
    <div class="modal-body">
      <div class="row">
        <div class="col-md-12 text-right">
          <button type="button" class="btn btn-outline-warning task"
                  (click)="openAssignPicker(assignContent)">
            <i class="material-icons">perm_identity</i> {{assignment}}
          </button>
          <button class="btn btn-outline-warning task" type="button"
                  (click)="openDatePicker(dateContent)">
            <i class="material-icons">event</i>{{model_date?.day}}-{{model_date?.month}}-{{model_date?.year}}
          </button>
        </div>
  
      </div>
  
      <div class="card" style="margin-top:15px">
        <input id="post-title" type="text" name="postTitle" [(ngModel)]="post.title" placeholder="Insert title here ..." style="padding: 12px 15px; font-style: italic; width: 100%; outline: none;" />
        <quill-editor [modules]="modules" id="post-content" [(ngModel)]="post.content" (blur)="onEditorBlured($event)"
                      [spellcheck]="true" name="postContent" (focus)="onEditorFocused($event)"
                      (ready)="onEditorCreated($event)" (onEditorCreated)="onEditorCreated($event)"
                      (change)="onContentChanged($event)"
                      (onContentChanged)="onContentChanged($event)"></quill-editor>
      </div>
  
      <div class="row" style="margin-bottom: 15px;">
        <div class="col-md-8">
          <button type="button" class="btn btn-link">
            <input id="cin" #fileInput type="file" class="btn btn-outline-warning task" style="display: none"
                   (change)="fileChangeEvent($event)" placeholder="File" multiple />
            <i class="material-icons" (click)="fileInput.click()">attach_file</i>
          </button>
  
         <button type="button" class="btn btn-link">
           <i class="material-icons" (click)="loadGoogleDrive();">
             cloud_upload
           </i>
         </button>
       </div>
  <!--  -->
       <!-- <div class="row">
        <div class="col-md-12" style="margin-left: 15px;">
          <input type="text" id="tags" [(ngModel)]="tag_search_words" (keyup)="tagListSearch()" (keydown)="addTags($event)" class="tags" placeholder="Add Tag here" name="tag" placement="top" ngbTooltip="Type & hit enter to add a tag">
        </div>
      </div> -->
      <div class="row">
          <div class="col-md-12" style="margin-left: 15px">
            <div ngbDropdown #myTagsDrop="ngbDropdown" class="search">
              <input ngbDropdownAnchor type="text" id="tags" class="tags" placeholder="Add Tag here" ng-show="tags_search_words" (keyup)="tagListSearch(); $event.stopPropagation(); myTagsDrop.open();" (keydown)="addTags($event)" [(ngModel)]="tags_search_words" name="tag" placement="top" ngbTooltip="Type & hit enter to add a tag">
                <div class="search-dropdown-menu" ngbDropdownMenu aria-labelledby="dropdownManual">
                  <div class="w-100" style="display:inline-block" *ngIf="tags_search_result?.length > 0">
                      <ul class=" list-tags" >
                        <li class="tags" *ngFor="let tag of tags_search_result; let i = index;">
                            <button class="bg-transparent border-0 col-lg-9 text-left" (click)="clickedOnTag(i)">{{ tag?.tags }}</button>
                        </li>
                      </ul>
                    </div>
              </div>
            </div>
          </div>
        </div>
  <!--  -->
    </div>
  
    <div class="row">
      <div class="col-md-1">
          <button type="button" class="btn btn-link">
              <i class="material-icons" placement="top" ngbTooltip="Tags">
                  local_offer
                  </i>
          </button>
      </div>
      <div class="col-md-10">
      <button class="btn btn-sm btn-outline-primary" style="margin-right: 1rem;" (click)="removeTag(i)" *ngFor="let tag of tags; let i = index" placement="top" ngbTooltip="Click here to remove this tag"><b>X</b> {{tag}}</button>
      </div>
    </div>
  
    <div class="row">
      <div class="col-md-12 text-right">
        <button (click)="closeCreatePostModal()" class="btn btn-default" id="cancel-task">Cancel</button>
      <button [disabled]="readyToAddTask()" class="btn btn-primary" id="create-task"
              (click)="addNewTaskPost();">Post Task
      </button>
    </div>
    </div>
      <div class="row">
        <div class="col-md-8 ">
  
          <div id="google-drive-file" style="display:none;"></div>
  
  
          <div *ngFor="let file of filesToUpload">
            <p><b>Uploaded file(s): </b>{{file.name}}</p>
          </div>
  
        </div>
  
      </div>
    </div>
  
  </ng-template>


<ng-template #editTaskModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Edit task</h4>
  </div>
  <div class="modal-body">
    <div class="row">
      <div class="col-md-12 text-right">
        <button type="button" class="btn btn-outline-warning task"
                (click)="openAssignPicker(assignContent)">
          <i class="material-icons">perm_identity</i> {{assignment}}
        </button>

        <button class="btn btn-outline-warning task" type="button"
                (click)="openDatePicker(dateContent)">
          <i class="material-icons">event</i>{{model_date?.day}}-{{model_date?.month}}-{{model_date?.year}}
        </button>
      </div>

    </div>

    <div *ngIf="modulesLoaded" class="card" style="margin-top:15px">
      <input id="post-title" type="text" [(ngModel)]="edit_post_title" style="padding: 12px 15px; font-style: italic; width: 100%; outline: none;" />
      <quill-editor [modules]="modules" id="post-content" [(ngModel)]="edit_post_content"
                    (blur)="onEditorBlured($event)"
                    [spellcheck]="true" name="postContent" (focus)="onEditorFocused($event)"
                    (ready)="onEditorCreated($event)" (onEditorCreated)="onEditorCreated($event)"
                    (change)="onContentChanged($event)"
                    (onContentChanged)="onContentChanged($event)"></quill-editor>
    </div>

    <div class="row">
      <div class="col-md-12" style="margin-left: 15px;">
        <input type="text" id="tags" (keydown)="addTags($event)" class="tags" placeholder="Add Tag here" [(ngModel)]="tag" name="tag" placement="top" ngbTooltip="Type & hit enter to add a tag">
      </div>
    </div>

    <div class="row">
        <div class="col-md-1">
            <button type="button" class="btn btn-link">
                <i class="material-icons" placement="top" ngbTooltip="Tags">
                    local_offer
                    </i>
            </button>
        </div>
        <div class="col-md-10">
        <button class="btn btn-sm btn-outline-primary" style="margin-right: 1rem;" (click)="removeTag(i)" *ngFor="let tag of tags; let i = index" placement="top" ngbTooltip="Click here to remove this tag"><b>X</b> {{tag}}</button>
        </div>
      </div>

    <div class="row" style="margin-bottom: 15px;">
      <div class="col-md-12 text-right">
          <button class="btn btn-default" id="cancel-task" (click)="this.editTaskModalRef.close();">Cancel</button>
        <button [disabled]="readyToEditTask()" class="btn btn-primary" id="create-task" (click)="editPost();">
          Edit Task
        </button>


      </div>
    </div>
  </div>
</ng-template>


<!-- Modal to pick a due date-->

<ng-template style="margin-top: 10px" #dateContent let-c="close" let-d="dismiss">

  <div style="width:100%" class="modal-header">
    <h4 class="modal-title">Select Due Date</h4>
    <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body">
    <ngb-datepicker #dp [(ngModel)]="model_date" (navigate)="date = $event.next"></ngb-datepicker>
  </div>

  <div class="modal-footer">
    <!-- in the personal workspace we don't use the assigned members function-->
    <button class="btn btn-primary mb-2 mr-2" (click)="c('Close click')">Done</button>

    <button type="button" class="btn btn-default mb-2 mr-2" (click)="c('Close click')">Cancel</button>
  </div>

</ng-template>

<!--  Modal to Assign calendar event or task to group member -->
<ng-template #assignContent let-c="close" let-d="dismiss">

  <div class="modal-header">
    <h4 class="modal-title">Search User</h4>
    <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <angular2-multiselect [data]="groupUsersList" [(ngModel)]="selectedGroupUsers" [settings]="settings"
                          (onSelect)="onItemSelect($event)" (onDeSelect)="OnItemDeSelect($event)"
                          (onSelectAll)="onSelectAll($event)"
                          (onDeSelectAll)="onDeSelectAll($event)">
      <c-search>
        <ng-template>
          <input type="text" (keyup)="onSearch($event)" placeholder="Name, Email, Username or Phone"
                 style="border: none;width: 100%; height: 100%;outline: none;"/>
        </ng-template>
      </c-search>
      <c-item>
        <ng-template let-item="item">
          <label style="color: #333;width: 150px;">{{item.full_name }}</label>
          <!--  <img [src]="item.flag" style="width: 30px; border: 1px solid #efefef;margin-right: 0px;"/> -->

          <label>{{item.capital}}</label>
        </ng-template>
      </c-item>
    </angular2-multiselect>

  </div>
  <div class="modal-footer">
    <button [disabled]="selectedGroupUsers.length == 0 " class="btn btn-primary mb-2 mr-2" (click)="c('Close click')">
      Done
    </button>
    <button type="button" class="btn btn-default mb-2 mr-2" (click)="c('Close click')">Cancel</button>
  </div>

</ng-template>
